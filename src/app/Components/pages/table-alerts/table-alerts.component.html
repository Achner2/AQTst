<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<div class="app-container">
  <header class="header w-full bg-white shadow-sm">
    <div class="header-container container mx-auto px-4 py-2 flex items-center justify-between">
      <div class="header-left flex items-center space-x-3">
        <button (click)="toggleSidebar()" class="menu-button p-2 focus:outline-none">
          <svg xmlns="http://www.w3.org/2000/svg" class="menu-icon h-6 w-6 text-gray-600" fill="none"
            viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
        <img class="logo h-8 md:h-10" src="../../../assets/AqtestLogofinal.png" alt="Aqutest Logo">
      </div>

      <div class="header-right flex items-center space-x-4">
        <app-notification></app-notification>
        <img class="logo2 hidden md:block h-8"
          src="https://excelec.com/wp-content/uploads/2021/06/cropped-excelec_logo.png" alt="Excelec Logo">
      </div>
    </div>
  </header>

  <aside class="sidebar" [ngClass]="{'sidebar-open': isSidebarOpen, 'sidebar-closed': !isSidebarOpen}">
    <div class="sidebar-content">
      <nav class="sidebar-nav">
        <a routerLink="/dashboard" class="nav-item text-lg">
          <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
            </path>
          </svg>
          Inicio
        </a>
        <!--
            <a routerLink="/equipments" class="nav-item text-lg">
              <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"></path></svg>
              Equipos
            </a>
            -->
        <a routerLink="/alerts" class="nav-item text-lg">
          <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
            </path>
          </svg>
          Alertas
        </a>
        <a routerLink="/metrics" class="nav-item text-lg">
          <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
            </path>
          </svg>
          Métricas
        </a>
        <a routerLink="/login" class="nav-item text-lg flex items-end space-x-2 hover:text-red-600 transition">
          <svg class="w-6 h-6 transition" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12H3m12 0l-4-4m4 4l-4 4M17 4h4v16h-4"></path>
          </svg>
          <span class="">Salir</span>
        </a>

      </nav>
    </div>
  </aside>


  <main class="main-content contentDs">
    <div class="container mx-auto py-4">

      <div class="container mx-auto py-8 px-4 sm:px-6 lg:px-8 bg-table rounded-xl shadow-sm max-w-7xl">

        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
          <h2 class="text-xl sm:text-2xl font-bold text-gray-800 tracking-tight">Sistema de Alertas</h2>

          <div class="flex flex-wrap gap-2 w-full sm:w-auto justify-start sm:justify-end items-center">
            <button (click)="exportarExcel()" class="btn btn-excel btn-export" title="Exportar Excel">
              <i class="fas fa-file-excel"></i>
            </button>
            <button (click)="exportarPDF()" class="btn btn-pdf btn-export" title="Exportar PDF">
              <i class="fas fa-file-pdf"></i>
            </button>
            <button (click)="imprimir()" class="btn btn-imprimir btn-export" title="Imprimir">
              <i class="fas fa-print"></i>
            </button>
            <button (click)="toggleFilters()"
              class="flex items-center gap-1.5 px-4 py-2 rounded-md bg-white border border-blue-200 text-blue-600 font-medium text-sm shadow-sm hover:bg-blue-50 hover:border-blue-300 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:ring-opacity-50">
              <span *ngIf="showFilters" class="w-4 h-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="m18 15-6-6-6 6" />
                </svg>
              </span>
              <span *ngIf="!showFilters" class="w-4 h-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="m6 9 6 6 6-6" />
                </svg>
              </span>
              {{ showFilters ? 'Ocultar filtros' : 'Mostrar filtros' }}
            </button>


          </div>
        </div>


        <div *ngIf="showFilters" class="filter-controls transition-all duration-300">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">

            <!-- Reemplazar el select original por el selector con búsqueda -->
            <div class="form-group">
              <label class="block text-sm font-medium text-gray-700 mb-1">Serial del Equipo</label>
              <div class="relative">
                <!-- Campo de búsqueda -->
                <input type="text" placeholder="Buscar equipo..." [(ngModel)]="searchTerm" (input)="filterEquipments()"
                  (focus)="showDropdown = true"
                  class="w-full px-4 py-2 border border-blue-200 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-blue-600 font-medium text-sm"
                  [disabled]="isLoadingEquipments">

                <!-- Icono de búsqueda -->
                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                  <svg class="h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                    fill="currentColor">
                    <path fill-rule="evenodd"
                      d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                      clip-rule="evenodd" />
                  </svg>
                </div>

                <!-- Indicador de carga -->
                <div *ngIf="isLoadingEquipments" class="absolute inset-y-0 right-8 flex items-center">
                  <div class="animate-spin h-4 w-4 border-2 border-blue-500 rounded-full border-t-transparent"></div>
                </div>
              </div>

              <!-- Dropdown para resultados filtrados -->
              <div *ngIf="showDropdown && filteredEquipments.length > 0"
                class="absolute z-10 mt-1 w-full sm:w-auto bg-white shadow-lg max-h-64 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto">
                <div class="cursor-pointer hover:bg-blue-50 px-4 py-2 text-sm text-gray-700"
                  (click)="selectEquipment(null)">
                  Todos los equipos
                </div>
                <div *ngFor="let serial of filteredEquipments"
                  class="cursor-pointer hover:bg-blue-50 px-4 py-2 text-sm text-gray-700"
                  (click)="selectEquipment(serial)">
                  {{ serial }}
                </div>
              </div>

              <!-- Mensaje de no resultados -->
              <div *ngIf="showDropdown && searchTerm && filteredEquipments.length === 0 && !isLoadingEquipments"
                class="absolute z-10 mt-1 w-full sm:w-auto bg-white shadow-lg rounded-md py-2 px-4 text-sm text-gray-500 ring-1 ring-black ring-opacity-5">
                No se encontraron equipos
              </div>
            </div>

            

            <div class="form-group">
              <label class="block text-sm font-medium text-gray-700 mb-1">Fecha inicio</label>
              <input type="date" [(ngModel)]="filters.dateMeasurementComponentStart"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div class="form-group">
              <label class="block text-sm font-medium text-gray-700 mb-1">Fecha fin</label>
              <input type="date" [(ngModel)]="filters.dateMeasurementComponentEnd"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
            <div class="form-group">
              <label class="block text-sm font-medium text-gray-700 mb-1">Valor mínimo</label>
              <input type="number" [(ngModel)]="filters.measurementValueStart"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div class="form-group">
              <label class="block text-sm font-medium text-gray-700 mb-1">Valor máximo</label>
              <input type="number" [(ngModel)]="filters.measurementValueEnd"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div class="form-group">
              <label class="block text-sm font-medium text-gray-700 mb-1">Código de Alerta</label>
              <select [(ngModel)]="filters.alertCode"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <option [ngValue]="null">Todos</option>
                <option value="03">Bajo</option>
                <option value="04">Bajo-Bajo</option>
                <option value="02">Alto</option>
                <option value="01">Alto-Alto</option>
              </select>
            </div>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Columnas visibles</label>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
              <div *ngFor="let column of availableColumns" class="flex items-center">
                <input type="checkbox" [id]="'col-' + column.value" [checked]="isColumnVisible(column.value)"
                  (change)="toggleColumn(column.value)"
                  class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <label [for]="'col-' + column.value" class="ml-2 block text-sm text-gray-700">
                  {{ column.name }}
                </label>
              </div>
            </div>

            <div class="flex flex-wrap gap-4 mb-4">
              <div class="flex items-center">
                <input type="checkbox" id="includeAllAlerts" [(ngModel)]="filters.includeAllAlerts"
                  class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <label for="includeAllAlerts" class="ml-2 block text-sm text-gray-700">
                  Incluir todas las alertas
                </label>
              </div>

              <div class="flex items-center">
                <input type="checkbox" id="excludeAlertCode00" [(ngModel)]="filters.excludeAlertCode00"
                  class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <label for="excludeAlertCode00" class="ml-2 block text-sm text-gray-700">
                  Excluir alertas normales (código 00)
                </label>
              </div>
            </div>

            <div class="flex flex-wrap gap-2">
              <button (click)="aplicarFiltros()"
                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Aplicar filtros
              </button>
              <button (click)="limpiarFiltros()"
                class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                Limpiar filtros
              </button>
            </div>
          </div>
        </div>

        <div *ngIf="isLoading" class="flex justify-center items-center py-8">
          <mat-spinner diameter="40"></mat-spinner>
          <span class="ml-3">Cargando datos...</span>
        </div>

        <div *ngIf="!isLoading"
          class="overflow-x-auto overflow-hidden rounded-xl shadow-md bg-white border border-gray-200">
          <div class="overflow-x-auto">
            <table mat-table [dataSource]="alertas" class="w-full min-w-full">

              <ng-container matColumnDef="Serial">
                <th mat-header-cell *matHeaderCellDef
                  class="px-6 py-3.5 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Serial</th>
                <td mat-cell *matCellDef="let alerta"
                  class="px-6 py-4 whitespace-nowrap text-sm font-normal text-gray-700 border-t border-gray-200">{{
                  alerta.Serial }}</td>
              </ng-container>


              <ng-container matColumnDef="Componente">
                <th mat-header-cell *matHeaderCellDef
                  class="px-6 py-3.5 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Componente
                </th>
                <td mat-cell *matCellDef="let alerta"
                  class="px-6 py-4 text-sm text-gray-700 border-t border-gray-200 max-w-xs truncate">{{
                  alerta.Componente }}</td>
              </ng-container>


              <ng-container matColumnDef="Variable">
                <th mat-header-cell *matHeaderCellDef
                  class="px-6 py-3.5 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Variable
                </th>
                <td mat-cell *matCellDef="let alerta"
                  class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 border-t border-gray-200">{{ alerta.Variable
                  }}</td>
              </ng-container>


              <ng-container matColumnDef="Unidades">
                <th mat-header-cell *matHeaderCellDef
                  class="px-6 py-3.5 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Unidades
                </th>
                <td mat-cell *matCellDef="let alerta"
                  class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 border-t border-gray-200">{{ alerta.Unidades
                  }}</td>
              </ng-container>


              <ng-container matColumnDef="FechaRecepcion">
                <th mat-header-cell *matHeaderCellDef
                  class="px-6 py-3.5 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Fecha
                  Recepción</th>
                <td mat-cell *matCellDef="let alerta"
                  class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 border-t border-gray-200">{{
                  alerta.FechaRecepcion }}</td>
              </ng-container>


              <ng-container matColumnDef="Fechaemedicion">
                <th mat-header-cell *matHeaderCellDef
                  class="px-6 py-3.5 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Fecha
                  Medición</th>
                <td mat-cell *matCellDef="let alerta"
                  class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 border-t border-gray-200">{{
                  alerta.Fechaemedicion }}</td>
              </ng-container>


              <ng-container matColumnDef="Valor">
                <th mat-header-cell *matHeaderCellDef
                  class="px-6 py-3.5 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Valor</th>
                <td mat-cell *matCellDef="let alerta"
                  class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 border-t border-gray-200">{{ alerta.Valor }}
                </td>
              </ng-container>


              <ng-container matColumnDef="Estado">
                <th mat-header-cell *matHeaderCellDef
                  class="px-6 py-3.5 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Estado</th>
                <td mat-cell *matCellDef="let alerta"
                  class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 border-t border-gray-200">
                  <span [ngClass]="{
                    'bg-red-50 text-red-700 ring-1 ring-red-600/10': alerta.Estado === 'Bajo-Bajo' || alerta.Estado === 'Alto-Alto',
                    'bg-yellow-50 text-yellow-700 ring-1 ring-yellow-600/10': alerta.Estado === 'Bajo' || alerta.Estado === 'Alto',
                    'bg-green-50 text-green-700 ring-1 ring-green-600/10': alerta.Estado === 'Normal',
                    'bg-blue-50 text-blue-700 ring-1 ring-blue-600/10': alerta.Estado === 'Resuelta'
                  }" class="px-2.5 py-0.5 text-xs font-medium rounded-full">
                    {{ alerta.Estado }}
                  </span>
                </td>
              </ng-container>


              <ng-container matColumnDef="TipoMedicion">
                <th mat-header-cell *matHeaderCellDef
                  class="px-6 py-3.5 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tipo
                  Medición</th>
                <td mat-cell *matCellDef="let alerta"
                  class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 border-t border-gray-200">{{
                  alerta.TipoMedicion }}</td>
              </ng-container>

              <ng-container matColumnDef="Icono">
                <th mat-header-cell *matHeaderCellDef
                  class="px-6 py-3.5 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                  Alerta
                </th>
                <td mat-cell *matCellDef="let alerta"
                  class="px-6 py-4 whitespace-nowrap text-sm border-t border-gray-200">
                  <i [class]="'fas ' + alerta.alertIcon" [style.color]="alerta.alertColorHex" class="text-lg"></i>

                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="columnas"></tr>
              <tr mat-row *matRowDef="let row; columns: columnas;"
                class="transition-all duration-200 ease-in-out hover:bg-gray-50 group"></tr>
            </table>
          </div>
        </div>

        <mat-paginator [length]="totalItems" [pageSize]="pageSize" [pageSizeOptions]="[7, 10, 20]"
          (page)="onPageChange($event)" showFirstLastButtons
          class="bg-white rounded-xl mt-4 shadow-sm border border-gray-100">
        </mat-paginator>
      </div>
    </div>
  </main>
</div>